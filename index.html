<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- CHANGE 1: APP NAME -->
    <title>UPSC PRE PYQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Shared Logic & Styles -->
    <link href="assets/css/style.css" rel="stylesheet">
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/DataManager.js"></script>
    <style>
        .q-count-btn.active { background-color: #1e293b; color: white; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- TOP BAR -->
    <header class="h-16 flex-none bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-30 px-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-slate-100 p-0.5 shadow-sm border border-slate-200 overflow-hidden">
                <img src="assets/images/Omg.jpg" alt="Profile" class="w-full h-full object-cover">
            </div>
            <div>
                <!-- CHANGE 2: USER NAME -->
                <h1 class="text-sm font-bold text-slate-900 leading-tight">Hello, <span id="user-name">Adimaanav</span></h1>
                <p class="text-[10px] text-slate-500 font-medium uppercase tracking-wide">Target: CSE 2026</p>
            </div>
        </div>
        
        <!-- Auto-Save Indicator -->
        <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-50 rounded-full border border-slate-100 transition-all opacity-0" id="auto-save-indicator">
            <i class="fa-solid fa-check-circle text-emerald-500 text-xs"></i>
            <span class="text-[10px] font-bold text-emerald-600">Saved</span>
        </div>
    </header>

    <!-- SCROLLABLE CONTENT -->
    <main class="flex-1 overflow-y-auto p-4 pb-24 space-y-6 scroll-smooth">

        <!-- 1. MAIN PROGRESS CARD -->
        <div class="glass-card rounded-3xl p-6 relative overflow-hidden group shadow-lg"> 
            <div class="absolute top-0 right-0 w-40 h-40 bg-blue-500/5 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>
            
            <div class="relative z-10">
                <div class="flex space-x-6 border-b border-slate-200/60 mb-4">
                    <button onclick="switchTab('gs1')" id="tab-gs1" class="tab-active pb-2 text-sm transition-colors">GS Paper 1</button>
                    <button onclick="switchTab('csat')" id="tab-csat" class="tab-inactive pb-2 text-sm transition-colors hover:text-slate-600">CSAT Paper 2</button>
                </div>

                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="text-[10px] font-bold px-2 py-1 rounded mb-2 inline-block border transition-colors" id="phase-badge">Phase 1: Foundation</span>
                        <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight" id="syllabus-percent">0%</h2>
                        <p class="text-xs text-slate-500 font-medium mt-1" id="syllabus-label">Syllabus Covered</p>
                    </div>
                    <div class="bg-white/60 p-2.5 rounded-xl shadow-sm text-center min-w-[70px] backdrop-blur-sm">
                        <div class="text-[10px] text-slate-400 font-bold uppercase">Attempts</div>
                        <div class="text-xl font-black text-slate-800" id="total-attempts">0</div>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-1.5 uppercase tracking-wide">
                        <span>Overall Progress</span>
                        <span id="progress-fraction">0 / 2000 Qs</span>
                    </div>
                    <div class="h-3 w-full bg-slate-100/80 rounded-full overflow-hidden border border-slate-200">
                        <div id="main-progress-bar" class="h-full progress-fill-gs1 rounded-full flex items-center justify-end pr-1" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. SUBJECT RAID GRID (Dynamic) -->
        <div>
            <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-play-circle text-blue-600"></i> Continue Progress
            </h3>
            
            <!-- This grid is now populated by JavaScript -->
            <div id="subject-grid" class="grid grid-cols-2 gap-3">
                <!-- Cards will be injected here -->
            </div>
        </div>

    </main>

    <!-- NEW: TOPIC SELECTION MODAL (Moved from Quiz Selection) -->
    <div id="topic-modal" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center pointer-events-none">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity opacity-0 pointer-events-auto" id="topic-bg" onclick="closeModal()"></div>
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl shadow-2xl transform translate-y-full transition-transform duration-300 pointer-events-auto flex flex-col max-h-[85vh]" id="topic-content">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <div>
                    <span class="text-xs font-bold text-blue-600 uppercase tracking-wide" id="m-subject-tag">GS1</span>
                    <h2 class="text-xl font-bold text-slate-900 mt-1" id="m-subject-title">Polity</h2>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Select Topic</label>
                    <div class="space-y-2" id="m-subtopics"></div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Number of Questions</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="selectCount(10, this)" class="q-count-btn active bg-slate-900 text-white py-2 rounded-lg font-bold text-sm">10</button>
                        <button onclick="selectCount(20, this)" class="q-count-btn bg-slate-100 text-slate-600 py-2 rounded-lg font-bold text-sm hover:bg-slate-200">20</button>
                        <button onclick="selectCount(50, this)" class="q-count-btn bg-slate-100 text-slate-600 py-2 rounded-lg font-bold text-sm hover:bg-slate-200">50</button>
                        <button onclick="selectCount(100, this)" class="q-count-btn bg-slate-100 text-slate-600 py-2 rounded-lg font-bold text-sm hover:bg-slate-200">100</button>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2" id="time-estimate"><i class="fa-regular fa-clock mr-1"></i> Est. Time: 12 mins</p>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100">
                <button onclick="launchQuiz()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 active:scale-[0.98] transition-transform flex justify-center items-center gap-2">
                    <span>Start Quiz</span> <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bg-white border-t border-slate-200 h-16 flex items-center justify-around fixed bottom-0 w-full z-20">
        <button onclick="window.location.href='index.html'" class="text-blue-600 flex flex-col items-center w-16 active:scale-95 transition-transform">
            <i class="fa-solid fa-house text-lg mb-1"></i>
            <span class="text-[10px] font-bold">Home</span>
        </button>
        <button onclick="window.location.href='quiz_selection.html'" class="text-slate-400 flex flex-col items-center w-16 active:scale-95 transition-transform hover:text-blue-600">
            <i class="fa-solid fa-pen-nib text-lg mb-1"></i>
            <span class="text-[10px] font-bold">Quiz</span>
        </button>
        <button onclick="window.location.href='stats.html'" class="text-slate-400 flex flex-col items-center w-16 active:scale-95 transition-transform hover:text-blue-600">
            <i class="fa-solid fa-chart-pie text-lg mb-1"></i>
            <span class="text-[10px] font-bold">Stats</span>
        </button>
        <button onclick="window.location.href='settings.html'" class="text-slate-400 flex flex-col items-center w-16 active:scale-95 transition-transform hover:text-blue-600">
            <i class="fa-solid fa-gear text-lg mb-1"></i>
            <span class="text-[10px] font-bold">Settings</span>
        </button>
    </nav>

<script>
    // --- 1. DATA DEFINITIONS ---
    const subjectsGS1 = [
        { id: 'polity', name: 'Indian Polity', icon: 'fa-landmark', color: 'orange', topics: ['All Topics', 'Preamble', 'Fundamental Rights', 'Parliament', 'Judiciary'] },
        { id: 'history_mod', name: 'Modern India', icon: 'fa-feather-pointed', color: 'yellow', topics: ['All Topics', '1857 Revolt', 'Gandhian Era', 'Social Reforms'] },
        { id: 'history_anc', name: 'Ancient India', icon: 'fa-scroll', color: 'amber', topics: ['All Topics', 'Indus Valley', 'Vedic Age', 'Mauryan'] },
        { id: 'history_med', name: 'Medieval India', icon: 'fa-chess-rook', color: 'amber', topics: ['All Topics', 'Delhi Sultanate', 'Mughals'] },
        { id: 'art', name: 'Art & Culture', icon: 'fa-palette', color: 'rose', topics: ['All Topics', 'Architecture', 'Paintings', 'Dance'] },
        { id: 'geo_world', name: 'World Geo', icon: 'fa-earth-americas', color: 'blue', topics: ['All Topics', 'Geomorphology', 'Climatology'] },
        { id: 'geo_ind', name: 'Indian Geo', icon: 'fa-map-location-dot', color: 'cyan', topics: ['All Topics', 'Drainage System', 'Monsoon'] },
        { id: 'env', name: 'Environment', icon: 'fa-leaf', color: 'emerald', topics: ['All Topics', 'Ecology', 'Biodiversity', 'Climate Change'] },
        { id: 'econ', name: 'Indian Economy', icon: 'fa-indian-rupee-sign', color: 'green', topics: ['All Topics', 'Banking', 'Budget', 'Agriculture'] },
        { id: 'sci', name: 'Science & Tech', icon: 'fa-microchip', color: 'purple', topics: ['All Topics', 'Space', 'Biotech', 'IT & Telecom'] },
        { id: 'ir', name: 'IR', icon: 'fa-handshake', color: 'teal', topics: ['All Topics', 'Organizations', 'India & Neighbors'] },
        { id: 'misc', name: 'Miscellaneous', icon: 'fa-layer-group', color: 'gray', topics: ['All Topics', 'Schemes', 'Awards'] }
    ];

    const subjectsCSAT = [
        { id: 'math', name: 'Maths', icon: 'fa-calculator', color: 'indigo', topics: ['All Topics', 'Number System', 'Percentage'] },
        { id: 'reasoning', name: 'Reasoning', icon: 'fa-brain', color: 'indigo', topics: ['All Topics', 'Coding-Decoding', 'Blood Relations'] },
        { id: 'passage', name: 'Passages', icon: 'fa-book-open', color: 'indigo', topics: ['All Topics', 'Inference', 'Assumption'] }
    ];

    let state = {
        currentTab: 'gs1',
        selectedSubject: null,
        selectedTopic: 'All Topics',
        questionCount: 10,
        history: [] // Will hold loaded history
    };

    // --- 2. INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Load Real History
        if (window.appData && window.appData.getLocalHistory) {
            state.history = window.appData.getLocalHistory();
        }
        
        // Initial Render
        updateDashboardStats();
        renderSubjectGrid('gs1');
    });

    // --- 3. DYNAMIC RENDERING ---
    function switchTab(tab) {
        state.currentTab = tab;
        
        // Update Buttons
        document.getElementById('tab-gs1').className = tab === 'gs1' ? "tab-active pb-2 text-sm transition-colors cursor-default" : "tab-inactive pb-2 text-sm transition-colors hover:text-slate-600 cursor-pointer";
        document.getElementById('tab-csat').className = tab === 'csat' ? "tab-active border-b-3 border-amber-500 text-slate-900 font-extrabold pb-2 text-sm transition-colors cursor-default" : "tab-inactive pb-2 text-sm transition-colors hover:text-slate-600 cursor-pointer";
        
        // Update Progress Bar Color
        const bar = document.getElementById('main-progress-bar');
        bar.className = `h-full rounded-full flex items-center justify-end pr-1 ${tab === 'gs1' ? 'progress-fill-gs1' : 'progress-fill-csat'}`;
        
        // Rerender Grid
        renderSubjectGrid(tab);
    }

    function renderSubjectGrid(tab) {
        const container = document.getElementById('subject-grid');
        container.innerHTML = '';
        
        const data = tab === 'gs1' ? subjectsGS1 : subjectsCSAT;
        
        data.forEach((sub, index) => {
            // Calculate REAL Progress
            // Count how many questions of this subject are in history
            // Note: We count attempt entries. (In a real DB, you'd count unique Q IDs)
            // Assuming 500 questions available per subject for the visual bar
            const attempts = state.history.filter(h => 
                h.subject && h.subject.toLowerCase().includes(sub.name.split(' ')[0].toLowerCase())
            ).reduce((acc, h) => acc + (h.total || 0), 0); // Sum up questions attempted in each session
            
            const totalAvailable = 500; // Hardcoded "Repository Size" per subject for visual
            const percent = Math.min(100, Math.round((attempts / totalAvailable) * 100));
            const barColor = sub.color || 'blue'; // Fallback color

            const el = document.createElement('div');
            // Adding Animation delay based on index
            el.className = `subject-card bg-white p-4 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group cursor-pointer animate-fade-up`;
            el.style.animationDelay = `${index * 50}ms`;
            el.onclick = () => openTopicModal(sub); // Click opens modal directly

            el.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="w-8 h-8 rounded-lg bg-${barColor}-50 text-${barColor}-500 flex items-center justify-center">
                        <i class="fa-solid ${sub.icon}"></i>
                    </div>
                    <span class="text-[10px] font-bold text-slate-400 uppercase">${tab.toUpperCase()}</span>
                </div>
                <h4 class="font-bold text-sm text-slate-800 truncate">${sub.name}</h4>
                <div class="mt-2 flex items-center gap-2">
                    <div class="h-1.5 flex-1 bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full bg-${barColor}-500" style="width: ${percent}%"></div>
                    </div>
                    <span class="text-[9px] font-bold text-slate-400">${attempts}/${totalAvailable}</span>
                </div>
            `;
            container.appendChild(el);
        });
    }

    function updateDashboardStats() {
        let totalQs = 0;
        state.history.forEach(h => totalQs += (h.total || 0));
        
        document.getElementById('total-attempts').innerText = totalQs;
        
        // Update main progress bar (assuming 5000 total questions in app)
        const totalAppQs = 5000;
        const mainPercent = Math.min(100, Math.round((totalQs / totalAppQs) * 100));
        
        document.getElementById('syllabus-percent').innerText = mainPercent + '%';
        document.getElementById('progress-fraction').innerText = `${totalQs} / ${totalAppQs} Qs`;
        document.getElementById('main-progress-bar').style.width = `${mainPercent}%`;
    }

    // --- 4. MODAL LOGIC (Copied & Adapted) ---
    function openTopicModal(subject) {
        state.selectedSubject = subject;
        document.getElementById('m-subject-tag').innerText = state.currentTab.toUpperCase();
        document.getElementById('m-subject-title').innerText = subject.name;
        
        const container = document.getElementById('m-subtopics'); 
        container.innerHTML = '';
        
        subject.topics.forEach((topic, i) => {
            container.innerHTML += `
                <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-50 transition-colors">
                    <input type="radio" name="subtopic" value="${topic}" ${i===0?'checked':''} onchange="state.selectedTopic = this.value" class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                    <span class="text-sm font-medium text-slate-700">${topic}</span>
                </label>`;
        });
        state.selectedTopic = subject.topics[0];
        
        const modal = document.getElementById('topic-modal'); 
        modal.classList.remove('hidden'); 
        void modal.offsetWidth; 
        document.getElementById('topic-bg').classList.remove('opacity-0'); 
        document.getElementById('topic-content').classList.remove('translate-y-full');
    }

    function closeModal() {
        const bg = document.getElementById('topic-bg'); 
        const content = document.getElementById('topic-content');
        bg.classList.add('opacity-0'); 
        content.classList.add('translate-y-full');
        setTimeout(() => document.getElementById('topic-modal').classList.add('hidden'), 300);
    }

    function selectCount(n, btn) {
        state.questionCount = n;
        document.querySelectorAll('.q-count-btn').forEach(b => b.className = "q-count-btn bg-slate-100 text-slate-600 py-2 rounded-lg font-bold text-sm hover:bg-slate-200 transition-all");
        btn.className = "q-count-btn active bg-slate-900 text-white py-2 rounded-lg font-bold text-sm transition-all scale-105";
        
        const mins = state.currentTab === 'gs1' ? Math.round(n * 1.2) : Math.round(n * 1.5);
        document.getElementById('time-estimate').innerHTML = `<i class="fa-regular fa-clock mr-1"></i> Est. Time: ${mins} mins`;
    }

    function launchQuiz() {
        const config = {
            mode: 'test', // Default to test mode from dashboard
            paper: state.currentTab,
            subject: state.selectedSubject.name,
            topic: state.selectedTopic,
            count: state.questionCount,
            timeLimit: state.currentTab === 'gs1' ? state.questionCount * 1.2 * 60 : state.questionCount * 1.5 * 60
        };
        
        localStorage.setItem('upsc_quiz_config', JSON.stringify(config));
        
        // Redirect directly to quiz engine
        window.location.href = 'quiz_interface.html';
    }
</script>
</body>
</html>



